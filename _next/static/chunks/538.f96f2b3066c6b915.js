"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[538],{45538:function(e,t,n){n.r(t),n.d(t,{default:function(){return z}});var r=n(57437),a=n(2265),o=n(9285),i=n(51448);function l(e){let t=e.clone().normalize();return{latitude:i.MathUtils.radToDeg(Math.asin(t.y)),longitude:function(e){let t=e;for(;t>180;)t-=360;for(;t<-180;)t+=360;return t}(i.MathUtils.radToDeg(Math.atan2(t.x,t.z))-90)}}function s(e,t){return{rotationY:-i.MathUtils.degToRad(t+90),rotationX:i.MathUtils.degToRad(e)}}var c=n(36496),u=n(85903),d=n(54334),f=n(11612),h=n(51794);function g(e){let{texture:t,heightMap:n,autoRotate:c,rotationSpeed:u,onLocationClick:d,externalRef:f,initialFocus:g,mountainsDataset:p,segments:m=96,visible:y=!0}=e,x=(0,a.useRef)(null),w=f||x,{raycaster:M}=(0,o.D)(),[v,S]=(0,a.useState)(!1),{setHovered:b}=(0,h.B)();(0,a.useEffect)(()=>{if(w.current&&t&&!v){if(g){let{rotationX:e,rotationY:t}=s(g.latitude,g.longitude);w.current.rotation.set(e,t,0)}S(!0)}},[t,v,g]),(0,o.F)((e,t)=>{c&&w.current&&v&&(w.current.rotation.y+=u*t)});let R=(0,a.useMemo)(()=>new i.MeshStandardMaterial(t?{map:t,displacementMap:n||null,displacementScale:n?.08:0,displacementBias:0,roughness:1,metalness:0}:{color:"#444"}),[t,n]),C=(0,a.useRef)(null),B=(0,a.useRef)(!1),F=()=>{if(!w.current)return;let e=M.intersectObject(w.current);if(!e.length)return;let{point:t,uv:n}=e[0],r=w.current.quaternion.clone().invert(),a=t.clone().applyQuaternion(r),{latitude:o,longitude:i}=l(a),s=a.clone().normalize().multiplyScalar(1.5),c={latitude:o,longitude:i,timestamp:Date.now(),localVector:{x:s.x,y:s.y,z:s.z}};if(p&&p.width>0&&n){let e=n.x,t=n.y;e<0?e=0:e>1&&(e=1),t<0?t=0:t>1&&(t=1);let r=Math.min(p.width-1,Math.max(0,Math.round(e*(p.width-1)))),a=Math.min(p.height-1,Math.max(0,Math.round((1-t)*(p.height-1)))),o=a*p.width+r,i=p.data[o];c.mountainsValue=i,c.mountainsPixelX=r,c.mountainsPixelY=a,i>0&&d(c)}else d(c)};return y?(0,r.jsxs)("mesh",{ref:w,onPointerDown:e=>{C.current={x:e.clientX,y:e.clientY,t:performance.now()},B.current=!1},onPointerMove:e=>{if(C.current){let t=e.clientX-C.current.x,n=e.clientY-C.current.y;Math.sqrt(t*t+n*n)>6&&(B.current=!0)}if(w.current&&p){let e=M.intersectObject(w.current);if(e.length&&e[0].uv){let{x:t,y:n}=e[0].uv;t<0?t=0:t>1&&(t=1),n<0?n=0:n>1&&(n=1);let r=Math.min(p.width-1,Math.max(0,Math.round(t*(p.width-1)))),a=Math.min(p.height-1,Math.max(0,Math.round((1-n)*(p.height-1))))*p.width+r,o=Math.round(p.data[a]);if(o>0){let t=w.current.quaternion.clone().invert(),{latitude:n,longitude:r}=l(e[0].point.clone().applyQuaternion(t).clone().normalize().multiplyScalar(1.5));b({id:o,metadata:{latitude:n,longitude:r}})}else b(null)}else b(null)}},onPointerUp:e=>{if(!C.current)return;let t=B.current;C.current=null,t||F()},onPointerLeave:()=>{C.current=null,b(null)},children:[(0,r.jsx)("sphereGeometry",{args:[1.5,m,m]}),(0,r.jsx)("primitive",{object:R,attach:"material"})]}):null}function p(){let e=(0,a.useRef)(null),{camera:t}=(0,o.D)();return(0,o.F)(()=>{e.current&&(e.current.position.copy(t.position),e.current.lookAt(0,0,0))}),(0,r.jsx)("directionalLight",{ref:e,intensity:5,color:"#ffffff",castShadow:!1})}async function m(){try{let{fromUrl:e}=await Promise.all([n.e(471),n.e(929)]).then(n.bind(n,31471));return e}catch(e){throw console.warn("GeoTIFF 라이브러리 로딩 실패:",e),Error("GeoTIFF 라이브러리를 로드할 수 없습니다")}}async function y(e){try{let t=await m();return await t(e)}catch(t){throw console.warn("GeoTIFF 로딩 실패 (".concat(e,"):"),t),Error("GeoTIFF 파일을 로드할 수 없습니다: ".concat(t instanceof Error?t.message:"알 수 없는 오류"))}}async function x(e){return await new Promise((t,n)=>{new i.TextureLoader().load(e,e=>{e.colorSpace=i.SRGBColorSpace,t(e)},void 0,e=>n(e))})}async function w(e){let t;let n=await y(e),r=await n.getImage(),a=r.getWidth(),o=r.getHeight(),l=await r.readRasters({interleave:!0}),s=l instanceof Uint8Array?l:new Uint8Array(l),c=r.samplesPerPixel||3;if(3===c){t=new Uint8ClampedArray(a*o*4);for(let e=0,n=0;e<s.length;e+=3,n+=4)t[n]=s[e],t[n+1]=s[e+1],t[n+2]=s[e+2],t[n+3]=255}else if(4===c)t=new Uint8ClampedArray(s);else if(1===c){t=new Uint8ClampedArray(a*o*4);for(let e=0,n=0;e<s.length;e++,n+=4){let r=s[e];t[n]=r,t[n+1]=r,t[n+2]=r,t[n+3]=255}}else{t=new Uint8ClampedArray(a*o*4);for(let e=0;e<t.length;e+=4)t[e]=255,t[e+1]=0,t[e+2]=255,t[e+3]=255}let u=document.createElement("canvas");u.width=a,u.height=o;let d=u.getContext("2d"),f=d.createImageData(a,o);f.data.set(t),d.putImageData(f,0,0);let h=new i.CanvasTexture(u);return h.colorSpace=i.SRGBColorSpace,h.needsUpdate=!0,h}async function M(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=await y(e),r=await n.getImage(),a=r.getWidth(),o=r.getHeight(),l=(await r.readRasters({interleave:!1,samples:[0]}))[0],s=1/0,c=-1/0;for(let e=0;e<l.length;e++){let t=l[e];t<s&&(s=t),t>c&&(c=t)}let u=c-s||1,d=new Uint8ClampedArray(a*o*4);for(let e=0,n=0;e<l.length;e++,n+=4){let r=(l[e]-s)/u;t.invert&&(r=1-r);let a=Math.round(255*r);d[n]=a,d[n+1]=a,d[n+2]=a,d[n+3]=255}let f=document.createElement("canvas");f.width=a,f.height=o;let h=f.getContext("2d"),g=h.createImageData(a,o);g.data.set(d),h.putImageData(g,0,0);let p=new i.CanvasTexture(f);return p.needsUpdate=!0,p.wrapS=p.wrapT=i.RepeatWrapping,p}async function v(e){let t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{threshold:r=0,color:a="#ff8c00",maxAlpha:o=.85,scaleAlphaByValue:l=!1}=n,s=await y(e),c=await s.getImage(),u=c.getWidth(),d=c.getHeight(),f=(await c.readRasters({interleave:!1,samples:[0]}))[0],h=0;if(l){for(let e=0;e<f.length;e++){let t=f[e];t>h&&(h=t)}0===h&&(h=1)}let[g,p,m]=(3===(t=a.replace("#","").trim()).length&&(t=t.split("").map(e=>e+e).join("")),6!==t.length)?[255,140,0]:[parseInt(t.slice(0,2),16),parseInt(t.slice(2,4),16),parseInt(t.slice(4,6),16)],x=new Uint8ClampedArray(u*d*4);for(let e=0,t=0;e<f.length;e++,t+=4){let n=f[e];if(n>r){let e=o;l&&(e=Math.min(1,n/h*o)),x[t]=g,x[t+1]=p,x[t+2]=m,x[t+3]=Math.round(255*e)}else x[t]=0,x[t+1]=0,x[t+2]=0,x[t+3]=0}let w=document.createElement("canvas");w.width=u,w.height=d;let M=w.getContext("2d"),v=M.createImageData(u,d);v.data.set(x),M.putImageData(v,0,0);let S=new i.CanvasTexture(w);return S.colorSpace=i.SRGBColorSpace,S.needsUpdate=!0,S.wrapS=S.wrapT=i.RepeatWrapping,S.minFilter=i.LinearFilter,S}async function S(e){let t=await y(e),n=await t.getImage(),r=n.getWidth(),a=n.getHeight(),o=(await n.readRasters({interleave:!1,samples:[0]}))[0],i=new Float32Array(o.length),l=1/0,s=-1/0;for(let e=0;e<o.length;e++){let t=Number(o[e]);i[e]=t,t<l&&(l=t),t>s&&(s=t)}return l===1/0&&(l=0,s=0),{width:r,height:a,data:i,min:l,max:s}}function b(e){let{texture:t,radius:n=1.5,visible:l=!0,opacity:s=1,elevation:c=.0025,colorize:u=!0,blending:d="normal",backBrightness:f=.5,followRef:h,segments:g=96,heightMap:p,displacementScale:m=.08,displacementBias:y=.001}=e,x=(0,a.useRef)(null);(0,o.F)(()=>{(null==h?void 0:h.current)&&x.current&&x.current.quaternion.copy(h.current.quaternion)});let w=(0,a.useMemo)(()=>{if(!t)return null;if(p){let e=new i.MeshStandardMaterial({map:t,transparent:!0,depthWrite:!1,depthTest:!1,opacity:s,side:i.DoubleSide,blending:"additive"===d?i.AdditiveBlending:i.NormalBlending,toneMapped:!1,displacementMap:p,displacementScale:m,displacementBias:y,roughness:1,metalness:0,color:16777215});return e.onBeforeCompile=e=>{e.uniforms.uBackBrightness={value:f},e.fragmentShader=e.fragmentShader.replace("void main() {","uniform float uBackBrightness;\nvoid main() {").replace("#include <output_fragment>","#ifdef OPAQUE\n	gl_FragColor = vec4( diffuseColor.rgb, 1.0 );\n#else\n	gl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n#endif\n#if defined( USE_TRANSMISSION )\n	gl_FragColor.a *= transmissionAlpha + 0.1;\n#endif\nfloat brightness = gl_FrontFacing ? 1.0 : uBackBrightness;\n.gl_FragColor.rgb *= brightness;\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n")},e.polygonOffset=!0,e.polygonOffsetFactor=-1,e.polygonOffsetUnits=-1,e}let e=new i.MeshBasicMaterial({map:t,transparent:!0,depthWrite:!1,depthTest:!1,opacity:s,side:i.DoubleSide,blending:"additive"===d?i.AdditiveBlending:i.NormalBlending,toneMapped:!1});return e.onBeforeCompile=e=>{e.uniforms.uBackBrightness={value:f},e.fragmentShader=e.fragmentShader.replace("void main() {","uniform float uBackBrightness;\nvoid main() {").replace("#include <output_fragment>","#ifdef OPAQUE\n	gl_FragColor = vec4( diffuseColor.rgb, 1.0 );\n#else\n	gl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n#endif\n#if defined( USE_TRANSMISSION )\n	gl_FragColor.a *= transmissionAlpha + 0.1;\n#endif\nfloat brightness = gl_FrontFacing ? 1.0 : uBackBrightness;\n// Only scale RGB, keep alpha same so transparency unchanged\ngl_FragColor.rgb *= brightness;\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n")},e},[t,s,d,f,p,m,y]);return t&&w?(0,r.jsxs)("mesh",{ref:x,visible:l,renderOrder:9,children:[(0,r.jsx)("sphereGeometry",{args:[n+c,g,g]}),(0,r.jsx)("primitive",{object:w,attach:"material"})]}):null}var R=n(41889),C=n(40257);function B(e){let{folderPath:t,globeRef:n,segments:o=96,autoRefreshMs:l,heightMap:s,displacementScale:c=.08,displacementBias:u=5e-4}=e,d=(0,R.rh)(),f=(0,R.Ox)(e=>e.initialize),{registerTexture:h,markLoading:g,markError:p}=(0,R.Tv)(),m=a.useCallback(e=>{let t=(C.env.NEXT_PUBLIC_BASE_PATH||"").replace(/\/$/,"");return t?e.startsWith("/")?"".concat(t).concat(e):"".concat(t,"/").concat(e):e},[]);(0,a.useEffect)(()=>{let e,n=!1,r=async()=>{try{let e=null;try{let n=await fetch(m("/api/overlays?folder=".concat(encodeURIComponent(t))),{cache:"no-store"});if(n.ok){let t=await n.json();t.success&&(e=t.files)}}catch(e){}if(!e){let n=m("/overlays/manifest.json"),r=await fetch(n,{cache:"no-store"}),a=await r.json(),o=t.replace(/^\/+/,"");e=(a.files||[]).filter(e=>e.path.startsWith("/".concat(o)))}!n&&e&&f(e.map(e=>({id:e.id,name:e.name,path:m(e.path),extension:e.extension})))}catch(e){n||console.warn("[OverlayManager] list fetch error:",e)}};return r(),l&&l>0&&(e=setInterval(r,l)),()=>{n=!0,e&&clearInterval(e)}},[t,l,f]),(0,a.useEffect)(()=>{d.forEach(e=>{if(e.visible&&"idle"===e.status){g(e.id);let t=e.extension.toLowerCase();(async()=>{try{let n;".tif"===t||".tiff"===t?n=await v(e.path,{threshold:0,color:e.color,maxAlpha:.85,scaleAlphaByValue:!0}):((n=await x(e.path)).colorSpace=i.SRGBColorSpace,n.needsUpdate=!0),h(e.id,n,".tif"===t||".tiff"===t)}catch(t){p(e.id,String(t))}})()}})},[d,h,g,p]);let y=(0,a.useMemo)(()=>d.filter(e=>e.visible&&"ready"===e.status&&e.texture),[d]),w=(0,a.useMemo)(()=>[...y].sort((e,t)=>e.order-t.order),[y]);return(0,r.jsx)(r.Fragment,{children:w.map((e,t)=>(0,r.jsx)(F,{record:e,globeRef:n,segments:o,renderOrderBase:250+t,heightMap:s,displacementScale:c,displacementBias:u},e.id))})}function F(e){let{record:t,globeRef:n,segments:l,renderOrderBase:s,heightMap:c,displacementScale:u,displacementBias:d}=e,f=a.useRef(null);(0,o.F)(()=>{n.current&&f.current&&f.current.quaternion.copy(n.current.quaternion)});let h=a.useMemo(()=>{if(!t.texture)return null;if(c){let e=new i.MeshStandardMaterial({map:t.texture,transparent:!0,depthWrite:!1,depthTest:!0,opacity:t.opacity,side:i.FrontSide,toneMapped:!1,alphaTest:.05,blending:i.NormalBlending,displacementMap:c,displacementScale:null!=u?u:.08,displacementBias:null!=d?d:5e-4,roughness:1,metalness:0,color:16777215});return e.polygonOffset=!0,e.polygonOffsetFactor=-1,e.polygonOffsetUnits=-1,e}return new i.MeshBasicMaterial({map:t.texture,transparent:!0,depthWrite:!1,depthTest:!0,opacity:t.opacity,side:i.FrontSide,toneMapped:!1,alphaTest:.05,blending:i.NormalBlending})},[t.texture,t.opacity,c,u,d]);if(!h)return null;let g=(c?1.5:1.512)+(c?.001:0)+3e-4*t.order;return(0,r.jsxs)("mesh",{ref:f,renderOrder:s,children:[(0,r.jsx)("sphereGeometry",{args:[g,l,l]}),(0,r.jsx)("primitive",{object:h,attach:"material"})]})}function j(e){let{globeRef:t,focusStateRef:n,setFocusMode:r}=e,{camera:l}=(0,o.D)(),s=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];console.log("[FocusAnimator]",...t)},c=(0,a.useRef)(-1),u=(0,a.useRef)("idle"),d=(0,a.useRef)(new i.Quaternion);return(0,o.F)((e,a)=>{var o,i,f,h,g,p,m;let y=n.current;if("idle"===y.mode)return;y.progress+=a/1.1;let x=Math.min(1,y.progress),w=x*x*(3-2*x),M=t.current;u.current!==y.mode&&(s("Mode change",{from:u.current,to:y.mode}),u.current=y.mode);let v=Math.floor(100*x);if(v%10==0&&v!==c.current){c.current=v;let e=M?{y:M.position.y.toFixed(3)}:{};s("Progress",{mode:y.mode,pct:v,k:w.toFixed(3),camZ:l.position.z.toFixed(3),globeY:e})}if(M){if("focusing"===y.mode){let e=null!==(o=y.originalDistance)&&void 0!==o?o:l.position.length();if(y.startQuat&&y.targetQuat)d.current.copy(y.startQuat).slerp(y.targetQuat,w),M.quaternion.copy(d.current);else{let e=null!==(i=y.startRotX)&&void 0!==i?i:M.rotation.x,t=null!==(f=y.startRotY)&&void 0!==f?f:M.rotation.y,n=null!==(h=y.targetRotX)&&void 0!==h?h:e,r=null!==(g=y.targetRotY)&&void 0!==g?g:t;M.rotation.x=e+(n-e)*w,M.rotation.y=t+(r-t)*w}let t=l.position.clone().normalize();l.position.copy(t.multiplyScalar(e+(2-e)*w)),x>=1&&(y.mode="focused",y.progress=0,r("focused"),s("Focus complete"))}else if("unfocusing"===y.mode){if(y.startQuat&&y.targetQuat)d.current.copy(y.startQuat).slerp(y.targetQuat,w),M.quaternion.copy(d.current);else{let e=null!==(p=y.startRotX)&&void 0!==p?p:M.rotation.x,t=null!==(m=y.startRotY)&&void 0!==m?m:M.rotation.y;M.rotation.x=e+(0-e)*w,M.rotation.y=t+(0-t)*w}let e=l.position.clone().normalize();l.position.copy(e.multiplyScalar(2+1*w)),x>=1&&(y.mode="idle",y.progress=0,r("idle"),s("Unfocus complete"))}else if("focused"===y.mode){let e=l.position.clone().normalize();l.position.copy(e.multiplyScalar(2))}l.updateProjectionMatrix()}}),null}var A=n(2412),I=n(40257);function z(){let[e,t]=(0,a.useState)(null),[n,l]=(0,a.useState)(null),[m,y]=(0,a.useState)(null),[C,F]=(0,a.useState)(null),z=(0,A.H)(e=>e.showMountainsMask),[U,E]=(0,a.useState)(!0),[_,D]=(0,a.useState)(null),[k,V]=(0,a.useState)("idle"),[O,Q]=(0,a.useState)(null),[W,X]=(0,a.useState)(null),Y=(0,a.useRef)(null),N=(0,a.useRef)({mode:"idle",progress:0}),[q,G]=(0,a.useState)("idle"),L=e=>{let t=2*Math.PI;return((e+Math.PI)%t+t)%t-Math.PI},H=(e,t)=>{let n=L(t-e);return e+n},Z=(e,t,n)=>{if(!Y.current)return;let r=Y.current,a=r.rotation.x,o=r.rotation.y,l=L(e-a),s=L(t-o);if("focusing"===N.current.mode||"focused"===N.current.mode&&.002>Math.sqrt(l*l+s*s)&&!n)return;let c=H(a,e),u=H(o,t),d=r.getWorldPosition(new i.Vector3),f=ea.current,h=f?f.position.distanceTo(d):4;N.current={mode:"focusing",progress:0,startRotX:a,startRotY:o,originalDistance:h,targetRotX:c,targetRotY:u,startQuat:r.quaternion.clone(),targetQuat:n?n.clone():void 0},G("focusing")},$=(0,a.useRef)(null),K=(0,d.useComputedColorScheme)("light",{getInitialValueInEffect:!0}),J=e=>{let t=(I.env.NEXT_PUBLIC_BASE_PATH||"").replace(/\/$/,"");return t?e.startsWith("/")?"".concat(t).concat(e):"".concat(t,"/").concat(e):e},ee="light"===K?J("/earth_daymap.jpg"):J("/earth_nightmap.jpg");(0,a.useEffect)(()=>{let e=!1,n=ee.toLowerCase();return(n.endsWith(".tif")||n.endsWith(".tiff")?w(ee):x(ee)).then(n=>{e||t(n)}).catch(t=>{e||l(t.message)}),M(J("/earth.tif"),{invert:!0}).then(t=>{e||y(t)}).catch(()=>{}),V("loading"),v(J("/mountains.tif"),{threshold:0,color:"#37ff00ff",maxAlpha:1,scaleAlphaByValue:!0}).then(t=>{e||F(t)}).catch(t=>{e||console.warn("mountains.tif load fail",t)}),S(J("/mountains.tif")).then(t=>{e||(D(t),V("ok"),Q(null))}).catch(t=>{e||(console.warn("mountains single band load fail",t),V("error"),Q(String(t)))}),()=>{e=!0}},[ee]),(0,a.useEffect)(()=>{if(!_||!W||void 0!==W.mountainsValue)return;let{latitude:e,longitude:t}=W,n=t+90;for(;n<-180;)n+=360;for(;n>180;)n-=360;let r=(n+180)/360,a=Math.min(_.width-1,Math.max(0,Math.round(r*(_.width-1)))),o=Math.min(_.height-1,Math.max(0,Math.round((1-(e+90)/180)*(_.height-1))))*_.width+a,i=_.data[o];X({...W,mountainsValue:i})},[_,W]),(0,a.useEffect)(()=>{let e=()=>{if(!$.current)return;let e=$.current.querySelector("canvas");if(!e)return;let{clientWidth:t,clientHeight:n}=$.current;e.style.width=t+"px",e.style.height=n+"px"};return window.addEventListener("resize",e),setTimeout(e,100),()=>window.removeEventListener("resize",e)},[]);let et=(0,a.useRef)(null),{setSelected:en}=(0,h.B)(),er=(0,h.B)(e=>e.selected),ea=(0,a.useRef)(null),[eo,ei]=(0,a.useState)(!0),[el,es]=(0,a.useState)(0);(0,R.rh)();let{toggleVisibility:ec,setOpacity:eu,hideAll:ed,showAll:ef}=(0,R.Tv)();return(0,a.useEffect)(()=>{Y.current&&(!er||er.id<=0)&&"unfocusing"!==N.current.mode&&(N.current={mode:"unfocusing",progress:0,startRotX:Y.current.rotation.x,startRotY:Y.current.rotation.y,originalDistance:N.current.originalDistance,targetRotX:Y.current.rotation.x,targetRotY:Y.current.rotation.y},G("unfocusing"))},[er]),(0,r.jsxs)(f.Box,{ref:$,className:"three-canvas-container",pos:"absolute",top:0,left:0,right:0,bottom:0,w:"100%",h:"100%",style:{overflow:"hidden"},children:[(0,r.jsxs)(c.Xz,{camera:{position:[0,0,4]},style:{width:"100%",height:"100%",display:"block"},dpr:Math.min(1.5,window.devicePixelRatio),gl:{antialias:!0,alpha:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance"},resize:{scroll:!1,debounce:{scroll:50,resize:0}},children:[(0,r.jsx)(()=>{let{gl:t}=(0,o.D)();return(0,a.useEffect)(()=>{if(e){let n=t.capabilities.getMaxAnisotropy();e.anisotropy!==n&&(e.anisotropy=n,e.needsUpdate=!0)}},[e,t]),null},{}),(0,r.jsx)("ambientLight",{intensity:.3}),(0,r.jsx)(p,{}),(0,r.jsx)(g,{texture:e,heightMap:m,autoRotate:!1,rotationSpeed:.01,visible:U,onLocationClick:e=>{if(X(e),void 0!==e.mountainsValue&&e.mountainsValue>0){if(en({id:e.mountainsValue||0,metadata:{latitude:e.latitude,longitude:e.longitude}}),Y.current&&e.localVector&&ea.current){let t=Y.current.getWorldPosition(new i.Vector3),n=ea.current.position.clone(),r=new i.Vector3(e.localVector.x,e.localVector.y,e.localVector.z),a=r.clone().add(t);!function(e,t,n){let r=t.clone().sub(e),a=n.clone().sub(e),o=Math.acos(Math.max(-1,Math.min(1,(r.clone().cross(a).length(),r.normalize().dot(a.normalize()))))),l=Math.abs(o);l<i.MathUtils.degToRad(1)||i.MathUtils.degToRad(1),i.MathUtils.radToDeg(l),r.clone(),a.clone(),i.MathUtils.radToDeg(o)}(t,a,n);let{rotationX:o,rotationY:l,quaternion:s}=function(e,t){let n;let r=e.clone().normalize(),a=t.clone().normalize();if(-.999999>r.dot(a)){let e=new i.Vector3(1,0,0).cross(r).length()>.1?new i.Vector3(1,0,0):new i.Vector3(0,1,0);n=new i.Quaternion().setFromAxisAngle(e.cross(r).normalize(),Math.PI)}else n=new i.Quaternion().setFromUnitVectors(r,a);let o=new i.Euler().setFromQuaternion(n,"YXZ");return{rotationX:o.x,rotationY:o.y,quaternion:n}}(r,n.clone().sub(t).normalize());Z(o,l,s)}else{let t=s(e.latitude,e.longitude);Z(t.rotationX,t.rotationY)}}},externalRef:Y,mountainsDataset:_}),(0,r.jsx)(T,{onCapture:e=>{ea.current=e}}),(0,r.jsx)(u.z,{ref:et,enablePan:!1,enableRotate:"idle"===q,enableZoom:"idle"===q,minDistance:2,maxDistance:8}),(0,r.jsx)(j,{globeRef:Y,focusStateRef:N,setFocusMode:G}),(0,r.jsx)(P,{globeRef:Y,controlsRef:et,initialMeshRotation:{x:0,y:0},resetKey:el,onDelta:e=>{}}),(0,r.jsx)(b,{texture:C,visible:z,radius:1.504,elevation:.003,opacity:1,followRef:Y,heightMap:m,displacementScale:.08,displacementBias:.001}),(0,r.jsx)(B,{folderPath:"/overlays",globeRef:Y,segments:96,heightMap:m,displacementScale:.08,displacementBias:5e-4})]}),n&&(0,r.jsxs)("div",{style:{position:"absolute",top:8,left:8,color:"red",fontSize:12,zIndex:1e3,backgroundColor:"rgba(0,0,0,0.7)",padding:"4px 8px",borderRadius:"4px"},children:["Error: ",n]}),"loading"===k&&(0,r.jsx)("div",{style:{position:"absolute",top:76,right:16,background:"rgba(0,0,0,0.55)",color:"#fff",padding:"6px 10px",fontSize:12,borderRadius:6,zIndex:1100},children:"산 데이터 로딩중..."}),"error"===k&&(0,r.jsxs)("div",{style:{position:"absolute",top:76,right:16,background:"rgba(160,0,0,0.7)",color:"#fff",padding:"6px 10px",fontSize:12,borderRadius:6,zIndex:1100},children:["산 데이터 오류: ",O||"알 수 없는 오류"]})]})}function T(e){let{onCapture:t}=e,{camera:n}=(0,o.D)();return(0,a.useEffect)(()=>{t(n)},[n,t]),null}function P(e){let{globeRef:t,controlsRef:n,initialMeshRotation:r,onDelta:i,resetKey:l}=e,s=(0,a.useRef)({x:0,y:0}),c=(0,a.useRef)(null),u=e=>{let t=2*Math.PI;return((e+Math.PI)%t+t)%t-Math.PI};return(0,a.useEffect)(()=>{c.current=null,s.current={x:0,y:0},i({x:0,y:0})},[l]),(0,o.F)(()=>{let e=n.current;if(!e)return;let t="function"==typeof e.getAzimuthalAngle?e.getAzimuthalAngle():e.azimuthalAngle||0,r="function"==typeof e.getPolarAngle?e.getPolarAngle():e.polarAngle||0;c.current||(c.current={azimuthal:t,polar:r});let a=u(t-c.current.azimuthal),o=u(r-c.current.polar),l=-a;(Math.abs(o-s.current.x)>.004||Math.abs(l-s.current.y)>.004)&&(s.current={x:o,y:l},i({x:o,y:l}))}),null}}}]);